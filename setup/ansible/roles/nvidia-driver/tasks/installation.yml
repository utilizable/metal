#!/usr/bin/env ansible-playbook

#######################################
# BASE 
#######################################

- name: Gather system facts
  setup:

- name: Presence
  command: nvidia-smi 
  register: check_nvidia
  changed_when: false
  failed_when: false

- name: Installation 
  hosts: localhost
  block:
    - name: Get the latest NVIDIA download URL
      command: >
        curl -s -X GET https://download.nvidia.com/XFree86/Linux-x86_64/latest.txt
      register: nvidia_url_output
      changed_when: false  # To prevent Ansible from marking this task as changed unnecessarily

    - name: Ensure NVIDIA URL is fetched
      fail:
        msg: "Failed to fetch the NVIDIA download URL."
      when: nvidia_url_output.stdout is not none

    - name: Fetch latest Nvidia driver
      get_url:
        url: "https://download.nvidia.com/XFree86/{{ nvidia_url_output.stdout }}"
        dest: /tmp/nvidia.run
        mode: '0755'
      when: nvidia_url_output.stdout is not none

    - name: Install latest Nvidia driver 
      command: >
        /tmp/nvidia.run --silent --install-compat32-libs
      when: nvidia_url_output.stdout is not none
      register: install_output

    - name: Display installation output
      debug:
        var: install_output.stdout_lines
      when: install_output is defined

  when: check_nvidia.rc !=0
